<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
<title>Image Server Users Manual</title>
</head>
<body>

<h1>Image Server Users Manual</h1>

<h2>Table of Contents</h2>
<ol>
<li><a href="#Introduction">Introduction</a></li>
<li><a href="#Request Parameters">Request Parameters</a></li>
<li><a href="#Image Parameters">Image Parameters</a></li>
<li><a href="#Client Protocols">Client Protocols</a></li>
<ul type="disc">
<li><a href="#DCS">DCS</a></li>
<li><a href="#WEB">WEB</a></li>
<li><a href="#HTTP">HTTP</a></li>
</ul>
<li><a href="#Server Configuration">Server Configuration</a></li>
</ol>

<a name="Introduction"><h2>1. Introduction</h2></a>
<p>The Image Server serves diffraction images in the jpeg format to remote clients. 
The image (SMV, CBF, mar165, mar345 and mar300 formats) is first loaded from disk into 
cache and then converted into jpeg before sending it to the client. When the cache is 
full, the image that has not been used for the longest period of time will be removed 
from the cache. </p>

<p>The security check is done through the impersonation server using 
session ID and user name to ensure that the user has the read permission for the
requested file. </p>

<p>Client applications connect to the server via socket and use DCS, WEB or HTTP protocol
to communicate with the server in order to request for an image. The server can serve
all three protocols to different clients simultaneously on three different port.</p>

<p>When a request arrives, the server will first check if the user and sesion id are valid
and if the user has a permission to read the image file. This is done through the 
impersontation server. If all is well, the server will find the image from cache. If the image
is not in cache or if the image file is newer, it will load the image file from disk and
put it in the cache. </p>

<p>The also saves information about the users requesting for the image, including 
user name, session id, the time of last access, and the time of last sesion id validation. 
If the user requests for the same image again within a short period of time (the time of last 
sesion id validation until this request is shorter than <a href="#maxIdleTime">maxIdleTime</a>) the server will 
assume that the user and session id are still valid and the user still has the permission 
to read the image. The server will not revalidate the session id in this case in order to 
reduce network traffic and increase the performance.</p>

<a name="Request Parameters"><h2>2. Request Parameters</h2></a>
<p>A Client sends a request to the server to retrieve an image. Besides the image file name,
each request must also include parameters that determine the size, center position, brightness 
and zoom level of the returned image. In addition, the request must include a username
and session id used for security check. Below is the list of parameters required for
each request:</p>
<ul>
<li>userName: User login name</li>
<li>sessionId: A valid session id generated by the authentication server</li>
<li>imageFilename: Name of the image file to retrieve</li>
<li>sizex: size of jpeg image for display in pixels</li>
<li>sizey: size of jpeg image for display in pixels</li>
<li>zoom: Zoom level of the image for display. The value must grater than 0. For example, 
the image is unzoom at zoom level 1.0, 0.2 is zoom out, and 5.0 is zoom in. </li> 
<li>gray: Brightness of the image. 300-400 gives a nice contrast for 
typically diffraction images. 500 is lighter where as 200 is darker.</li>
<li>percentx: Center of the image. The value is between 0.0 and 1.0. 
For example, percentx=0.5 and percenty=0.5 is the middle of the image.
Top left corner is (0.0, 0.0) and bottom right corner is (1.0, 1.0).</li>
<li>percenty: Center of the image. See percentx above. </li>
</ul>


<a name="Image Parameters"><h2>3. Image Parameters</h2></a>

The server returns the requested jpeg image as well as the image parameters in the response.
For DCS protocol, the image parameters are in the first string. For the HTTP protocol,
the parameters are part of the response headers. For the WEB protocol, the parameters are 
saved in the header file (.txt).  

<p>Below is the list of parameters:</p>
<ul>
<li>wavelength: Wavelength of incident beam in Angstrom</li>
<li>distance: Distance from sample to detector in millimeters</li>
<li>originX: Beam center X on detector in millimeters</li>
<li>originY: Beam center Y on detector in millimeters</li>
<li>pixelSize: Size of a pixel in millimeters</li>
<li>time: Exposure time in seconds</li>
<li>detectorTypeC64: Detector type</li>
</ul>


<a name="Client Protocols"><h2>4. Client Protocols</h2></a>


<p>There are three protocols for the clients to communicate with the server: DCS, WEB and HTTP.
Each protocol defines a specific format and order of the request and response sent between 
the client and server.

</p>

<a name="DCS"><h3>DCS Protocol</h3></a>
<p>This protocol is currently used by Blu-Ice. A client connects to the server 
using socket. The connection is kept open the client disconnects or an error occurs.
The client sends a string request to the server. The request contains 9 fields
separated by a space, as shown below.
</p>
<p><i>userName sessionId imageFilename sizex sizey zoom gray percentx percenty</i></p>

For example,

<p><i>penjitk E1E85DB8003F9CA48BE2037E66736416 /data/penjitk/images/image1.img 500 500 5.0 400 0.2 0.5</i></p>


<p>The first line of the response contains 7 fields as follows:</p>

<p><i>success wavelength distance originX originY pixelSize time detectorTypeC64</i></p>

<p>The first field is always the string "success" followed by the image parameters.</p>

<p>What follows is the raw jpeg data sent in chunks of 8192 bytes. 
The last chunk is indicated by a string</p>
<p><i>stoc_END_JPEG_NEXT_BUFFER nnn</i></p>
<p>where nnn is the number of byte of the last chunk.</p>

<p>The socket connection remains open until the client closes it or an error occurs.
The client can send another request repeatedly after the previous response is complete.  
</p>


<a name="WEB"><h3>WEB Protocol</h3></a>

<p>The request of this protocol the same as the DCS protocol. The response, on the other hand, 
only contains a file name. For each request, the server writes out a jpeg file to a designated
directory (/home/webstaff/jpegscratch) readable only by the server and the WebImageViewer. 
The file name is automatically generated with .jpg has file extension. The filename is is unique 
and this is the file name that is sent in the response to the client. This jpeg has got the 
dimension, brightness, center position and the zoom level as specified in the request. </p>
<p>In addition, the server writes out another file with the same name but with .thumb.jpg file extension.
This is a thumbnail of the requested image. The zoom level is always at 1.0. If the requested
image is zoomed in, for example at zoom level 4.0, the thumbnail will display a regtangular 
box showing the area visible in the requested image. </p>
<p>The third file generated by the server contains the image headers including wavelength, distance, 
originX, originY, pixelSize, time, and detectorTypeC64. The file name is, again, the same
but the file extension is .txt.
</p>

For example:<br>

Request<br>

<p><i>penjitk E1E85DB8003F9CA48BE2037E66736416 /data/penjitk/images/image1.img 500 500 5.0 400 0.2 0.5</i></p>


Response<br>

<p><i>edk93la</i></p>

The client can load the following three files, generated by the server, for display:<br>
<i>
/home/webstaff/jpegscratch/edk93la.jpg<br>
/home/webstaff/jpegscratch/edk93la.thumb.jpg<br>
/home/webstaff/jpegscratch/edk93la.txt<br>
</i>



<a name="HTTP"><h3>HTTP Protocol</h3></a>

<p>Clients that use this protocol can be a web browser or another server that delegate 
a request to the image server.  The resource part of the URL is an image server command, namely getImage,
getThumbnail and getHeader. The request parameters are listed in the query part of
the URL. If the command is getHeader, only fileName, userName and sessionId parameters
are required. Otherwise all parameters as listed in secion 2 are must be present.</p>
For example,
<p><i>http://smbfs:14007/getImage?fileName=/data/penjitk/images/low_1/4c10p3_1_078.img&sizeX=500&sizeY=500&gray=400&zoom=3.0&percentX=0.5&percentY=0.9&userName=penjitk&sessionId=E1E85DB8003F9CA48BE2037E66736416</i></p>
<p><i>http://smbfs:14007/getThummbnail?fileName=/data/penjitk/images/low_1/4c10p3_1_078.img&sizeX=500&sizeY=500&gray=400&zoom=3.0&percentX=0.5&percentY=0.9&userName=penjitk&sessionId=E1E85DB8003F9CA48BE2037E66736416</i></p>
<p><i>http://smbfs:14007/getHeader?fileName=/data/penjitk/images/low_1/4c10p3_1_078.img&userName=penjitk&sessionId=E1E85DB8003F9CA48BE2037E66736416</i></p>

<p>The response header contains the following image parameters described in section 3.

For example,

<p>
<i>
HTTP/1.1 200 OK<br>
Connection: close<br>
Server: Image Server/2.0<br>
wavelength: 0.979991<br>
distance: ADSC QUANTUM4<br>
originX: 94.000000<br>
originY: 94.000000<br>
pixelSize: 0.0816<br>
time: 20<br>
detectorTypeC64: ADSC QUANTUM4<br>
Content-Type: image/jpeg<br>
<br>             
jpeg data<br>
<br>
</i>
</p>

</body>
</html>

<h2><a name="Server Configuration">Server Configuration</a></h2>

<p>The server reads a dcs configuration file at startup. The name of the configuration file
is specified as a commandline argument. Each line in the file contains a pair of name and value
separated by a comma. See dcsconfig document for more details about config format and how the config
is used by applications in the dcs system. Typically, the imgsrv is run with the following command (for example, on smb):
</p>

<p>
>cd imgsrv/irix<br>
>./imgsrv ../../dcsconfig/data/default.config<br>
</p>

The config in default.config file used by the imgsrv are the following:
<p><i>
# image server<br>
imgsrv.host=smb.slac.stanford.edu<br>
imgsrv.guiPort=14005<br>
imgsrv.webPort=14006<br>
imgsrv.httpPort=14007<br>
imgsrv.tmpDir=/home/webstaff/jpegscratch<br>
imgsrv.maxIdleTime=60<br>

# impersoanation server<br>
imperson.host=smb.slac.stanford.edu<br>
imperson.port=61001<br>
</i></p>

<p>
where
<br>imgsrv.host: Host name of this imgsrv. Used by DCS applications to locate the imgsrv. 
<br>imgsrv.guiPort: Port number for the DCS protocol
<br>imgsrv.webPort: Port number for the WEB protocol
<br>imgsrv.httpPort: Port number for the HTTP protocol
<br>imgsrv.tmpDir: Directory used by the WEB protocol for writing the output files
<br>imgsrv.maxIdleTime: Number of seconds before the server needs to revalidate the session id. 
<br>imperson.impersonHost: Host name of the impersonation server used for validing the session id and checking user's read permission for the image file
<br>imperson.impersonPort: Port number of the impersonation server
</p>



